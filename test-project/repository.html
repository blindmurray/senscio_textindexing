<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Repository</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/requirejs/require.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/client.js"></script>
  <meta name="google-signin-client_id" content="953997974940-6oclg8f4hefo52qlufnb7bj1j0jscuoc.apps.googleusercontent.com">
  <link rel="stylesheet" href="css/jquery-ui.css"> </head>

<body onload="onPageLoad()">
  <div class="news">
    <div class="nav">
      <ul>
        <li><a class="active" href="repository.html">Repository</a></li>
        <li><a href="upload.html">Upload</a></li>
        <li><a href="search.html">Search</a></li>
        <li><span id="account">My Account</span>
          <div id="myModal4" class="modal">
            <div class="modal-content"> <span class="closeBABA" id="close6">&times;</span>
              <div>Please Sign In With a Senscio Systems Email:</div>
              <div id="signIn3" class="g-signin2" data-onsuccess="onSignIn"></div>
              <div>Please Sign Out Here:</div>
              <div onclick="signOut();">Sign out</div>
            </div>
          </div>
        </li>
      </ul>
    </div> <br>
    <div>
      <span class="buttons_upload" id="show_hide">
        <img src = /images/show_hide.jpg>
        <span id="hide">Hide All Files</span>
        <span id="show" style="display:none">Show All Files</span>
      </span>
      <span class="buttons_upload" id="deletefile">
        <img src="/images/delete.jpg"> Delete a File</span><br><br>
      <input type="hidden" name="path" value="" id="pathtoadd" class="path_to_add">
      <div id="repositoryTree"><span id="tree"> </span></div> <br>
    </div>
  </div>
  <br><br>
  <div class="foot">
    <p id="text">Senscio Systems, Inc.<br> 1740 Massachusetts Ave<br> Boxborough, MA 01719<br> (978) 635-9090 </p>
  </div>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <script src="jquery-3.2.1.min.js"></script>
  <script>
    var email = "";
    var oldId = "No Path Selected";
    //stores bolded folder id
    function triggerSelect(clicked_ID) {
      "use strict";
      var el = document.getElementById(clicked_ID);
      document.getElementById("pathtoadd").value = clicked_ID;
      el.style.fontWeight = "bold";
      el.classList.add("checked");
      if(oldId !== "No Path Selected") {
        var p = document.getElementById(oldId);
        p.style.fontWeight = "normal";
        p.classList.remove("checked");
      }
      oldId = clicked_ID;
    }
    //shows chosenfolder after button click
    function onChooseLocation() {
      "use strict";
      document.getElementById("chosenFolder").value = oldId;
      document.getElementById("location").innerHTML = oldId;
      modal.style.display = "none";
    }
    //tree
    function prepareList() {
      "use strict";
      $("#repositoryTree").find("li:has(ul)").click(function (event) {
        if(this == event.target) {
          $(this).toggleClass("collapsed");
          $(this).toggleClass("expanded");
          $(this).children("ul").toggle("medium");
        }
        return false;
      }).addClass("collapsed").children("ul").hide();
      //Hack to add links inside the cv
      $("#expList a").unbind("click").click(function () {
        window.open($(this).attr("href"));
        return false;
      });
      //Create the button funtionality
      $("#expandList").unbind("click").click(function () {
        $(".collapsed").children("ul").show("medium");
      });
      $("#collapseList").unbind("click").click(function () {
        $(".expanded").children("ul").hide("medium");
      });
    }

    function ajax() {
      "use strict";
      if(window.XMLHttpRequest) {
        return new XMLHttpRequest();
      }
      else if(window.ActiveXObject) {
        try {
          return new ActiveXObject("Msxml2.DOMDocument.6.0");
        }
        catch(e) {}
        try {
          return new ActiveXObject("Msxml2.DOMDocument.3.0");
        }
        catch(f) {}
        try {
          return new ActiveXObject("Microsoft.XMLHTTP");
        }
        catch(g) {}
      }
      else {
        alert("newxhr XMLHTTPRequest object failed");
        return null;
      }
    }
    var acc = document.getElementById("account")
    var modal4 = document.getElementById("myModal4");
    acc.onclick = function () {
      "use strict";
      modal4.style.display = "block";
    };
    var span4 = document.getElementById("close6");
    span4.onclick = function () {
      modal4.style.display = "none";
    }
    //Choose Location: make tree
    function onPageLoad() {
      if(gapi.auth2.getAuthInstance()) {
        var profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile()
        email = profile.getEmail();
      }
      var tree = {
        "id": "tree",
        "email": email
      };
      var json = JSON.stringify(tree);
      var xhr = ajax();
      xhr.onload = function () {
        if(xhr.readyState === 4) {
          if(xhr.status === 200) {
            document.getElementById("tree").innerHTML = xhr.responseText;
            prepareList();
          }
          else {
            alert("Error: " + xhr.responseText);
          }
        }
      };
      xhr.open("POST", "/", true);
      xhr.setRequestHeader("Content-Type", "text/plain");
      xhr.send(json);
    }
    //Add a Folder functionality
    var modal2 = document.getElementById("myModal2");
    //reveal textbox to enter folder name
    var deletebtn = document.getElementById("deletefile");
    deletebtn.onclick = function () {
      if(gapi.auth2.getAuthInstance()) {
        var profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile()
        email = profile.getEmail();
      }
      console.log(email);
      var path = document.getElementById("pathtoadd").value;
      var folderjson = {
        "id": "deleteFile",
        "filepath": path,
        "email": email
      };
      folderjson = JSON.stringify(folderjson);
      var xhr = ajax();
      xhr.onload = function () {
        if(xhr.readyState === 4) {
          if(xhr.status === 200) {
            if((xhr.responseText).startsWith("Y")) {
              alert(xhr.responseText);
            }
            else {
              alert("Deleted!");
              document.getElementById("tree").innerHTML = xhr.responseText;
              prepareList();
            }
          }
          else {
            alert("Error: " + xhr.responseText);
          }
        }
      };
      xhr.open("POST", "/", true);
      xhr.setRequestHeader("Content-Type", "text/plain");
      xhr.send(folderjson);
    };

    function signOut() {
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
    }
    $("#show_hide").click(function () {
      $("#repositoryTree ul .file").toggle();
      $('#hide').toggle();
      $('#show').toggle();
      $('#repositoryTree li .folder').toggleClass('toggled');
    });
  </script>
</body>
</html>